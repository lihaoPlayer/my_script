# coding: utf-8
import threading
import subprocess as sp


def dig(domain, timeout=2):
    command = ["dig", "+time={}".format(timeout), domain]
    try:
        sp.check_call(command, stdout=sp.PIPE, stderr=sp.PIPE)
    except sp.CalledProcessError:
        return False
    return True


def dig_thread(host, result, timeout=2):
    result[host] = dig(host, timeout)
    return


def dig_parallel(domains, timeout=2):
    """并发 dig 所有域名"""
    threads = []
    result = dict()
    for domain in domains:
        thread = threading.Thread(target=dig_thread,
                                  args=(domain, result, timeout))
        thread.start()
        threads.append(thread)
    for thread in threads:
        thread.join()
    return result


def is_dns_ok():
    return any(
        dig_parallel(
            ["sn-dns.sp.baishan.com", "www.baidu.com", "www.google.com"]).values())


if __name__ == '__main__':
    print(dig_parallel(
        ["sn-dns.sp.baishan.com", "www.baidu.com", "www.google.com"],
        timeout=1))
