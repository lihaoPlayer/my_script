# coding: utf-8
# 用于获取网卡信息

import os
import glob
import sys
sys.path.append('..')
from bstools.netfunc import load_ifcfg_content


def read_text(f):
    with open(f) as fp:
        return fp.read()

def read_bypass_failure(f):
    try:
        return read_text(f).strip()
    except:
        pass

    return None


class Adapter:
    """主要为了查找物理网卡"""
    def __init__(self, name):
        self.name = name
        self._path = "/sys/class/net/{}".format(name)

    def __str__(self):
        return format_adapter(self)

    def get_file(self, name):
        return "{}/{}".format(self._path, name)

    @property
    def address(self):
        return read_bypass_failure(self.get_file("address"))

    @property
    def speed(self):
        speed = read_bypass_failure(self.get_file("speed"))
        if speed:
            return int(speed)

        return speed

    @property
    def status(self):
        return read_bypass_failure(self.get_file("operstate"))

    @property
    def bond_master_name(self):
        return load_ifcfg_content(self.name).get("MASTER", "")

    def is_virtual(self):
        """我们只需要物理网卡"""
        f = "/sys/devices/virtual/net/{}".format(self.name)
        return os.path.exists(f)

    def is_special(self):
        for i in ['lo', 'docker']:
            if self.name.startswith(i):
                return True
        return False


class Adapters:

    @classmethod
    def adapters(cls):
        __adapters = []
        for path in glob.glob("/sys/class/net/*"):
            if os.path.isfile(path):
                continue

            adapter = Adapter(os.path.basename(path))
            __adapters.append(adapter)
        return __adapters

def space_pad(name, width):
    l = len(name)
    delta = width - l
    if delta > 0:
        return "{}{}".format(name, " "* delta)
    return name

def format_adapter(adapter):
    return "{}{}{}{}{}".format(
        space_pad(adapter.name, 15),
        space_pad(adapter.status, 15),
        space_pad(str(adapter.speed), 8),
        space_pad(adapter.address, 20),
        adapter.bond_master_name,
    )


if __name__ == "__main__":
    for a in Adapters.adapters():
        print(format_adapter(a))